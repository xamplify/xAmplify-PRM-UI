<div class="page-content" *ngIf="showContactDeals && !showDealForm" style="padding-top: 10px;">
  <div class="page-bar mb-height_auto" style="height:48px;">
    <ul class="page-breadcrumb">
      <li><i class="fa fa-home" aria-hidden="true"></i>
        <a [routerLink]="referenceService?.homeRouter" translate>Home</a>
        <i class="fa fa-angle-right" aria-hidden="true"></i>
      </li>
      <li *ngIf="!isFromCompanyModule && !isCompanyJourney && !isFromCompanyJourneyEditContacts">
        <a (click)="goBackToManageContacts()" translate> Manage Contacts
        </a>
      </li>
      <li *ngIf="isFromCompanyModule || isCompanyJourney || isFromCompanyJourneyEditContacts">
        <a translate (click)="goBackToManageCompanies()">Manage Companies</a>
      </li>
      <li *ngIf="isFromCompanyJourneyEditContacts">
        <a (click)="goBackToCompanyJourney()" translate>
          <i class="fa fa-angle-right" aria-hidden="true"></i>Company Journey
        </a>
      </li>
      <li *ngIf="(isFromEditContacts && !isCompanyJourney) || isFromCompanyJourneyEditContacts">
        <a (click)="goBackToEditContacts()" translate>
          <i class="fa fa-angle-right" aria-hidden="true"></i>Edit Contacts
        </a>
      </li>
      <li *ngIf="isFromCompanyJourney">
        <a (click)="goBackToCompanyJourney()" translate>
          <i class="fa fa-angle-right" aria-hidden="true"></i>Company Journey
        </a>
      </li>
      <li>
        <a (click)="goBackToContactDetailsPage()" translate>
          <i class="fa fa-angle-right" aria-hidden="true"></i>{{isCompanyJourney ? 'Company':'Contact'}} Journey
        </a>
      </li>
      <li>
        <a translate>
          <i class="fa fa-angle-right" aria-hidden="true"></i>All Deals
        </a>
      </li>
    </ul>
  </div>
  <div class="page-bar p10">
    <div class="remove_cardBgcolor padding_0" id="header">
      <app-response-message [customResponse]="dealsResponse" *ngIf="dealsResponse.isVisible"></app-response-message>
      <div class="portlet-title">
        <div class="" style="padding-bottom: 45px;" *ngIf="!httpRequestLoader.isLoading">
          <div class="page-toolbar col-xs-6 col-sm-6 col-lg-5 pull-right m_mb8">
            <div class="search-and-filter">
              <a *ngIf="(isPartnerVersion || isOrgAdmin || authenticationService.module.isMarketingCompany) && !authenticationService?.module?.deletedPartner && isRegisterDealEnabled && !isCompanyJourney && (authenticationService?.enableLeads || authenticationService?.module?.opportunitiesAccessAsPartner)"
                (click)="addDeal()">
                <button class="button_blue bgcolor-unset p0 btn-transitions mrgt1-2" translate>
                  <span class="btn btn-primary transition d-inline"><i class="fa fa-plus"
                      aria-hidden="true"></i>{{DEAL_CONSTANTS?.registerADeal}}</span>
                </button>
              </a>
              <div class="inputs" align="right" style="float: right; display: inline-flex;">
                <div class="portlet-input input-inline" style="display: table-cell; margin-right: 15px;">
                  <div class="input-icon right" style="position: relative;right: -11px;">
                    <input type="text" class="form-control" [(ngModel)]="dealsSortOption.searchKey"
                      [ngModelOptions]="{standalone: true}" placeholder="Search"
                      (keypress)="dealEventHandler($event.keyCode)">
                    <button class="glyphicon glyphicon-remove search-box-item-clear" *ngIf="dealsSortOption.searchKey"
                      (click)="clearSearch()"></button>
                    <button type="submit" class="search-box-item-click" (click)="searchDeals()">
                      <i class="fa fa-search" aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
              </div>
              <span data-placement="bottom" class="btn btn-xs hidden-xs l-g-view" data-toggle="tooltip" title="Filter"
                *ngIf="listView" (click)="toggleFilterOption()">
                <i _ngcontent-c17="" aria-hidden="true" class="fa fa-filter p10"></i>
              </span>
              <div class="" style="margin-left: 4px;">
                <a data-placement="bottom" (click)="showDeals()" class="btn btn-xs  l-g-view" data-toggle="tooltip"
                  title="Refresh">
                  <i _ngcontent-c17="" class="fa fa-refresh p10" aria-hidden="true"></i>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- -------------------- Apply Filters Box-------------------- -->
        <div class="row" *ngIf="showFilterOption && !httpRequestLoader.isLoading && !httpRequestLoader.isServerError">
          <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="portlet light">
              <div class="portlet-title">
                <div class="caption" translate>Apply Filters</div>
                <button type="button" class="close-circle" style="margin-left: 10px;" (click)="closeFilterOption()">
                  <i class="fa fa-times" aria-hidden="true"></i>
                </button>
                <div class="form-group" style="text-align: -webkit-right;">
                  <button class="button bgcolor-unset neg_mrgn_top4 mrgn_top0" type="button"
                    (click)="validateDateFilters()">
                    <span class="btn Btn-Green transition txt_pd-top3">Filter</span>
                  </button>
                </div>
              </div>
              <!--Filter Options-->
              <div class="portlet-body clearfix">
                <app-response-message class="pg8" [customResponse]="filterResponse"
                  *ngIf="filterResponse.isVisible"></app-response-message>
                <form class="form-horizontal form-bordered form-label-stripped">
                  <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
                    <!--From Date-->
                    <div class="form-group">
                      <label class="control-label col-sm-5">From Date</label>
                      <div class="col-sm-7">
                        <app-date-picker [(dataField)]="fromDateFilter" [isFromFilter]='true'></app-date-picker>
                      </div>
                    </div>
                    <!--Status-->
                    <div class="form-group">
                      <label class="control-label col-sm-5">Status</label>
                      <div class="col-sm-7">
                        <p class="mt--10px" *ngIf="statusLoader">
                          <strong><img class="h-50px" src="../../../assets/images/Spinner.gif" alt="">Loading
                            Status...</strong>
                        </p>
                        <app-searchable-dropdown *ngIf="!statusLoader && isStatusLoadedSuccessfully"
                          [searchableDropDownDto]="statusSearchableDropDownDto" [id]="statusFilter"
                          [disableDropDown]="false" (searchableDropdownEventEmitter)="getSelectedStatus($event)">
                        </app-searchable-dropdown>
                        <p class="required" *ngIf="!statusLoader && !isStatusLoadedSuccessfully">
                          <strong>{{properties?.SOMTHING_WENT_WRONG}}</strong>
                        </p>
                      </div>
                    </div>
                  </div>

                  <div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
                    <!--To Date-->
                    <div class="form-group">
                      <label class="control-label col-sm-5">To Date</label>
                      <div class="col-sm-7">
                        <app-date-picker [(dataField)]="toDateFilter" [isFromFilter]='true'></app-date-picker>
                      </div>
                    </div>

                    <!--Added For-->
                    <div class="form-group" *ngIf="isPartnerVersion && !vanityLoginDto?.vanityUrlFilter">
                      <label class="control-label col-sm-5">Added For</label>
                      <div class="col-sm-7">
                        <app-searchable-dropdown [searchableDropDownDto]="registeredForCompaniesSearchableDropDownDto"
                          [id]="vendorCompanyIdFilter" [disableDropDown]="false"
                          (searchableDropdownEventEmitter)="getSelectedRegisteredForCompanyId($event)">
                        </app-searchable-dropdown>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <app-list-loader *ngIf="httpRequestLoader.isLoading && !httpRequestLoader.isServerError"></app-list-loader>
        <section class='col-xs-12 col-sm-12 col-md-12 col-lg-12 p0'
          [hidden]="!listView || dealsSortOption.totalRecords == 0 || httpRequestLoader.isLoading || httpRequestLoader.isServerError">
          <div class="table-responsive pt_12" [hidden]="httpRequestLoader.isLoading">
            <table class='table tgrid table-hover table-sm' aria-describedby="dealTable">
              <thead>
                <tr>
                  <th class="center-aligned" translate>Deal Details</th>
                  <th class="center" translate>{{DEAL_CONSTANTS.addedBy}}</th>
                  <th class="center" translate>Status</th>
                  <th style="width: 18%; text-align:right" translate>Actions</th>
                </tr>
              </thead>
              <tbody>
                <ng-container *ngFor='let deal of dealsPagination.pagedItems; let i=index'>
                  <tr>
                    <td style="width: 40%;padding: 10px;">
                      <div><span data-toggle="tooltip" data-placement="top" title="{{deal.title}}"><b>Deal
                            Name:</b> {{deal.title | slice:0:30}}
                          <span *ngIf="deal.title?.length>30">...</span></span>
                      </div>
                      <div>
                        <span *ngIf="isVendorVersion"><b>Deal Id:</b> {{deal.referenceId}}</span>
                      </div>
                      <div>
                        <h5 *ngIf="isPartnerVersion"><b>Added For:</b>
                          <span style="color: #5b9bd1;">{{deal.createdForCompanyName | slice:0:30}}
                            <span *ngIf="deal.createdForCompanyName?.length>30">...</span>
                          </span>
                        </h5>
                      </div>
                      <div>
                        <h5 *ngIf="isPartnerVersion && deal?.campaignId > 0" data-toggle="tooltip"
                          data-placement="bottom" title="{{deal.campaignName}}"><b>Campaign:</b>
                          <span style="color: #5b9bd1;">{{deal.campaignName | slice:0:30}}
                            <span *ngIf="deal.campaignName?.length>30">...</span>
                          </span>
                        </h5>
                        <h5 *ngIf="isVendorVersion && deal?.parentCampaignId > 0" data-toggle="tooltip"
                          data-placement="bottom" title="{{deal.parentCampaignName}}"><b>Campaign:</b>
                          <span style="color: #5b9bd1;">{{deal.parentCampaignName | slice:0:30}}
                            <span *ngIf="deal.campaignName?.length>30">...</span>
                          </span>
                        </h5>
                      </div>

                    </td>
                    <td style="width: 20%;">
                      <h5 *ngIf="!isPartnerVersion" data-toggle="tooltip" data-placement="bottom"
                        title="{{deal.createdByCompanyName}}">{{deal.createdByCompanyName | slice:0:30}}
                        <span *ngIf="deal.createdByCompanyName?.length>30">...</span>
                      </h5>
                      <h5 class='m_t_view' data-toggle="tooltip" data-placement="bottom" title="{{deal.createdByName}}"
                        style="margin: 7px 0 2px 0;font-weight: 400;">
                        {{deal.createdByName | slice:0:20}}
                        <span *ngIf="deal.createdByName?.length>20">...</span>
                      </h5>
                      <h6 class='m0' style="font-weight: 400;">
                        <a data-toggle="tooltip" data-placement="bottom"
                          title="{{deal.createdByEmail}}">{{deal.createdByEmail | slice:0:30}}</a>
                        <span *ngIf="deal.createdByEmail?.length>30">...</span>
                      </h6>
                      <h5 style="font-weight: 600; color: #676767;">
                        <app-timestamp [isOnlyDate]="false" [dateAndTime]="deal.createdTime">
                        </app-timestamp>
                      </h5>
                    </td>
                    <td style="width: 20%;">
                      <span class="comment-color" translate>
                        {{deal.currentStageName}}</span>

                      <a *ngIf="((deal?.showDealActions && deal?.showEditDealStage) || (isVendorVersion && deal?.showEditDealStage)) && (authenticationService?.enableLeads || authenticationService?.module?.opportunitiesAccessAsPartner)"
                        data-rel="fancybox-button"
                        (click)="updatePipelineStage(deal,authenticationService?.module?.deletedPartner)"
                        data-toggle="tooltip" data-placement="bottom" title="Edit Deal Stage">
                        <span class="fa fa-edit mr5 IconCustomization" aria-hidden="true"></span>
                      </a>

                    </td>
                    <td style="width: 20%;">
                      <div class="actions-block override-actions actionbtn">
                        <a class="custom-icon" data-rel="fancybox-button" (click)="viewDeal(deal)" data-toggle="tooltip"
                          data-placement="bottom" title="View Deal" id="deal">
                          <i class="fa fa-eye mr5 IconCustomization" aria-hidden="true"></i>
                          <div class="clickicons"></div>
                        </a>
                        <span *ngIf="deal.unReadPropertyChatCount > 0 && dealsCount"
                          class="badge badge-default notify-badge"
                          style="margin-bottom: 25px; margin-left: -15px;background-color: #ed1c24 !important;">{{deal.unReadPropertyChatCount}}</span>
                        <ng-container *ngIf="!authenticationService?.module?.deletedPartner && (authenticationService?.enableLeads || authenticationService?.module?.opportunitiesAccessAsPartner)">
                          <a class="custom-icon" data-rel="fancybox-button"
                            *ngIf="deal.canUpdate && !(isPartnerVersion && deal?.onNonInteractiveStage)"
                            (click)="deal?.showDealActions?editDeal(deal):''" data-toggle="tooltip"
                            data-placement="bottom" title="Edit Deal" id="deal">
                            <i [ngClass]="deal?.showDealActions? '':'disabled gray'" aria-hidden="true"
                              class="fa fa-edit mr5 IconCustomization"></i>
                            <div class="clickicons"></div>
                          </a>
                          <a class="custom-icon" data-rel="fancybox-button"
                            *ngIf="deal.canUpdate && !(isPartnerVersion && deal?.onNonInteractiveStage)"
                            (click)="deal?.showDealActions ? confirmDeleteDeal(deal):''" data-toggle="tooltip"
                            data-placement="bottom" title="Delete Deal" id="deal">
                            <i [ngClass]="deal?.showDealActions ? '':'disabled gray'" aria-hidden="true"
                              class="fa fa-trash-o trashIconCustomization"></i>
                            <div class="del-icon"></div>
                          </a>
                        </ng-container>

                        <a class="custom-icon" *ngIf="true" data-rel="fancybox-button" (click)="showComments(deal)"
                          data-toggle="tooltip" data-placement="bottom" title="Comments/History">
                          <i class="fa fa-comments IconCustomization" aria-hidden="true" style="font-size:18px">
                          </i>
                          <div class="clickicons"></div>
                        </a>
                        <span *ngIf="deal.unReadChatCount > 0" class="badge badge-default notify-badge"
                          style="margin-bottom: 25px; margin-left: -15px;background-color: #ed1c24 !important;">{{deal.unReadChatCount}}</span>
                      </div>
                    </td>
                  </tr>

                </ng-container>
              </tbody>
            </table>
          </div>

          <!-- --------------------Pagination0-------------------- -->
          <div *ngIf="!httpRequestLoader.isLoading" class="pg8 pos_mrg_top8">
            <app-pagination [pagination]="dealsPagination" (notifyParent)="setDealsPage($event)"
              (notifyParentDropDown)="listDealsForPartner($event)"></app-pagination>
          </div>
          <!-- End of 24 -->
          <div *ngIf="!httpRequestLoader.isLoading && dealsPagination.totalRecords==0 && !httpRequestLoader.isLoading"
            class="alert alert-info">
            <strong translate>No Deals Found.</strong>
          </div>
        </section>
        <div *ngIf="listView && !httpRequestLoader.isLoading && dealsSortOption.totalRecords==0"
          class="col-xs-12 col-sm-12 col-md-12 col-lg-12 alert alert-info">
          <strong>No Deals Found.</strong>
        </div>
      </div>
      <div class="portlet-body">
        <div class="row" id="box" style="padding-left: 28px !important;" *ngIf="httpRequestLoader.isServerError"
          translate>
          Please contact admin for 'Deals'
        </div>
      </div>
    </div>
  </div>
</div>

<app-add-deal *ngIf="showDealForm" [dealId]="dealId" [actionType]="actionType" [isVendorVersion]="isVendorVersion"
  [isFromCompanyJourney]="isFromCompanyJourney" [selectedUserListId]="selectedContactListId"
  [isCompanyJourney]="isCompanyJourney" [selectedContact]="selectedContact" [isOrgAdmin]="isOrgAdmin"
  [isDealFromContact]="isDealFromContact" [isFromEditContacts]="isFromEditContacts"
  (notifySubmitSuccess)="showSubmitDealSuccess()" (notifyClose)="closeDealForm()" [isFromContactAllDealsTab]="'true'"
  [companyJourneyId]="companyJourneyId"
  [isFromCompanyJourneyEditContacts]="isFromCompanyJourneyEditContacts"></app-add-deal>

<app-opportunities-chat-modal-popup *ngIf="updateCurrentStage" [deal]="selectedDeal" [isFromCompanyJourney]="isCompanyJourney"
  [isPartnerVersion]="isPartnerVersion" [isVendorVersion]="isVendorVersion" [isCommentSection]="isCommentSection"
  [loggedInUserId]="loggedInUserId" [textAreaDisable]="textAreaDisable" (showCommentsEmitter)="showComments($event)"
  (closePopupEmitter)="resetModalPopup()" (stageUpdateStatusCode)="stageUpdateResponse($event)">
</app-opportunities-chat-modal-popup>

<app-deal-chat-popup *ngIf="isCommentSection" [deal]="selectedDeal" [editTextArea]="textAreaDisable"
  [isVendorVersion]="isVendorVersion" (isCommentSection)="addCommentModalClose($event)"></app-deal-chat-popup>