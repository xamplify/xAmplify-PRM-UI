<div class="modal fade right" id="addEmailModalPopup" role="dialog" aria-labelledby="myModalLabel"
  data-backdrop="static" data-keyboard="false">
  <app-response-message class="pg8" [customResponse]="customResponse" *ngIf="!OliveAi && customResponse?.isVisible"></app-response-message>
  <div class="modal-dialog" [ngClass]="OliveAi ? '':'dymc_width'" role="document">
    <ngx-loading [show]="ngxLoading" [config]="{ backdropBorderRadius: '14px' }"></ngx-loading>
    <div class="modal-content">
      <div class="modal-header">
        <a class="close-circle" (click)="closeEmailModal()" data-dismiss="modal"> <i class="fa fa-times"></i></a>
        <h4 class="modal-title left" id="myModalLabel">{{ isPreview ? 'View':'Send'}} Email</h4>
      </div>
      <div class="modal-body">
        <app-response-message class="pg8" [customResponse]="customResponse" *ngIf="OliveAi && customResponse?.isVisible"></app-response-message>
        <div>
          <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12 p0 display_flex" *ngIf="!isPreview">
            <label for="exampleInputEmail1" class="display_flex pr45">To <span class="text-danger">*</span></label>
            <input *ngIf="!isCompanyJourney && !OliveAi && !composeMail && !replyMail" type="text" id="toEmailId" [(ngModel)]="emailActivity.toEmailId" [ngModelOptions]="{standalone: true}"
              placeholder="Email Id" class="form-control" name="toEmailId" maxlength="200" [disabled]="!isTestMail && !OliveAi && !composeMail && !replyMail" />
              <tag-input *ngIf="OliveAi || composeMail || replyMail" class="col-lg-11 col-md-11 col-sm-11 col-xs-11 p0" [(ngModel)]='toEmailIds' #tagInput name="emails" #email="ngModel"
               [errorMessages]="errorMessages" [validators]="validators"
               [separatorKeyCodes]="[32,188,186,13,9]" [placeholder]="'Add email'"
               [secondaryPlaceholder]="'Add EmailId(s)'" [clearOnBlur]="true" [addOnPaste]="true"
               [addOnBlur]="true" [pasteSplitPattern]="splitPattern" [onAdding]="onAddedFunc" theme='bootstrap'
               [onTextChangeDebounce]="40">
            </tag-input>
            <app-dropdown-loader *ngIf="userListUsersLoader?.isLoading && isCompanyJourney" [text]="'contacts'"></app-dropdown-loader>
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 p0" *ngIf="!userListUsersLoader?.isLoading && isCompanyJourney">
              <angular4-multiselect [data]="userListUsersData" [(ngModel)]="userIds"
              [settings]="dropdownSettings" (onSelect)="onItemSelect($event)" (onDeSelect)="OnItemDeSelect($event)"
              (onSelectAll)="onSelectAll($event)" (onDeSelectAll)="onDeSelectAll($event)"></angular4-multiselect>
            </div>
          </div>
          <div *ngIf="(!showCCEmailInputField || !showBCCEmailInputField)" class="f_r">
            <span class="mr5" *ngIf="!showCCEmailInputField" data-toggle="tooltip" data-placement="bottom" title="Add Cc recipients"><a class="underline-on-hover" (click)="showCCEmailInputField = 'true'"><span>Cc</span></a></span>
            <span *ngIf="!showBCCEmailInputField" data-toggle="tooltip" data-placement="bottom" title="Add Bcc recipients"><a class="underline-on-hover" (click)="showBCCEmailInputField = 'true'"><span>Bcc</span></a></span>
          </div>
          <div *ngIf="showCCEmailInputField" class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12 p0 display_flex">
            <label class="display_flex pt12 pr46" for="exampleInputEmail1">CC</label>
            <tag-input *ngIf="!isPreview" class="col-lg-11 col-md-11 col-sm-11 col-xs-11 p0" [(ngModel)]='ccEmailIds' #tagInput name="emails" #email="ngModel"
               [errorMessages]="errorMessages" [validators]="validators"
               [separatorKeyCodes]="[32,188,186,13,9]" [placeholder]="'Add email'"
               [secondaryPlaceholder]="'Add Cc recipient(s)'" [clearOnBlur]="true" [addOnPaste]="true"
               [addOnBlur]="true" [pasteSplitPattern]="splitPattern" [onAdding]="onAddedFunc" theme='bootstrap'
               [onTextChangeDebounce]="40">
            </tag-input>
          </div>
          <div *ngIf="showBCCEmailInputField" class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12 p0 display_flex">
            <label class="pr36 pt11" for="exampleInputEmail1">BCC</label>
            <tag-input *ngIf="!isPreview" class="col-lg-11 col-md-11 col-sm-11 col-xs-11 p0" [(ngModel)]='bccEmailIds' #tagInput name="emails" #email="ngModel"
               [errorMessages]="errorMessages" [validators]="validators"
               [separatorKeyCodes]="[32,188,186,13,9]" [placeholder]="'Add email'"
               [secondaryPlaceholder]="'Add Bcc recipient(s)'" [clearOnBlur]="true" [addOnPaste]="true"
               [addOnBlur]="true" [pasteSplitPattern]="splitPattern" [onAdding]="onAddedFunc" theme='bootstrap'
               [onTextChangeDebounce]="40">
            </tag-input>
            <input *ngIf="isPreview" type="text" id="toEmailId" [(ngModel)]="emailActivity.bccEmailIds" [ngModelOptions]="{standalone: true}"
             placeholder="Email Id" class="form-control" name="toEmailId" maxlength="200" disabled />
          </div>
          <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12 p0 display_flex">
            <label for="exampleInputEmail1" class="display_flex pr25">From <span class="text-danger">*</span></label>
            <input type="text" id="toEmailId" [(ngModel)]="emailActivity.senderEmailId" [ngModelOptions]="{standalone: true}"
             placeholder="Email Id" class="form-control" name="toEmailId" maxlength="200" disabled />
          </div>
          <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12 p0 display_flex">
            <label class="display_flex pr7" for="subjectLine">Subject <span class="text-danger">*</span></label>
            <input type="text" id="subjectLine" [(ngModel)]="emailActivity.subject" [ngModelOptions]="{standalone: true}" [disabled]="isPreview || replyMail"
             placeholder="Subject Line" class="form-control" name="subjectLine" maxlength="200" (input)="validateEmail()" />
          </div>
          <div class="form-group">
            <label *ngIf="!isEmailTemplateActivated" for="subjectLine" class="mt5">Message <span class="text-danger">*</span></label>
            <label *ngIf="isEmailTemplateActivated" for="subjectLine" class="mt5">Select an Email Template <span class="text-danger">*</span></label>
            <span class="pull-right" *ngIf="!OliveAi && isValidToShowChooseTemplate && !composeMail && !replyMail">
              <label for="subjectLine">Choose Template </label>
              <app-custom-ui-switch [customSwitch]="isEmailTemplateActivated"
                (customUiSwitchEventEmitter)="changeStatus($event)"></app-custom-ui-switch>
            </span>
            <div *ngIf="isEmailTemplateActivated" class="btn-group pull-right mr5">
              <div class="inputs float-right" style="display: inline-flex;">
                <div class="ml5">
                  <input type="text" autocomplete="off" id="sort-text" class="form-control"
                    [(ngModel)]="emailTemplatesSortOption.searchKey" [ngModelOptions]="{standalone: true}" placeholder="Search..."
                    (keypress)="emailActivityEventHandler($event.keyCode)">
                  <button class="glyphicon glyphicon-remove search-box-item-clear" *ngIf="emailTemplatesSortOption.searchKey"
                    (click)="emailTemplatesSortOption.searchKey='';searchEmailTemplates()"></button>
                  <button type="submit" class="search-box-item-click" (click)="searchEmailTemplates();"><i class="fa fa-search"
                      aria-hidden="true"></i></button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group">
            <ngx-loading [show]="activationLoaderEnabled" [config]="{ backdropBorderRadius: '14px' }"></ngx-loading>
            <ckeditor *ngIf="!isEmailTemplateActivated && !activationLoaderEnabled" name="body" [(ngModel)]="emailActivity.body" (change)="validateEmail()"
            [ngModelOptions]="{standalone: true}" [config]="ckeConfig"></ckeditor>
            
            <div *ngIf="isEmailTemplateActivated && !activationLoaderEnabled" class="col-lg-12 col-md-12 col-sm-12 col-xs-12 template_box">
              <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 p0">
                <ng-template [ngTemplateOutlet]="emailTemplates" [ngTemplateOutletContext]="{emailTemplatesPagination:emailTemplatesPagination,selectedEmailTemplateRow:emailActivity.templateId}"></ng-template>
              </div>
              <div *ngIf="emailTemplatesPagination?.pagedItems?.length !== 0 && !emailTemplateLoader && isEmailTemplateActivated && !activationLoaderEnabled" class="fc-content">
                <app-pagination [pagination]="emailTemplatesPagination" (notifyParent)="paginateEmailTempaltes($event)"
                  (notifyParentDropDown)="findEmailTemplates($event)" [customDropDown]="true">
                </app-pagination>
              </div>
            </div>

            <p *ngIf="showCkEditorLimitErrorMessage" class="text-danger">You have reached the maximum character limit.</p>
          </div>

          <div class="form-group">
            <p *ngIf="showAttachmentErrorMessage" class="text-danger">The attachment exceeds the maximum allowed file size of 20MB. You can upload large files to a cloud storage service (e.g., Amazon S3, Google Drive) and share the download link.</p>
            <label for="attachments">Attachments:</label>
            <input *ngIf="!isPreview" id="fileInput" class="file-input" type="file" (change)="onFileChange($event)" multiple>
            <label for="fileInput" class="btn Btn-Green custom-file-label">
              Choose a file
            </label>
            <p *ngIf="showFileTypeError" class="text-danger">The selected file type is not supported. Please upload a file with a valid format.</p>
            <div *ngIf="!isPreview && (files.length > 0)">
              <ul>
                <li *ngFor="let file of files; let i = index">
                  {{ file.name }} ({{ file.size / 1024 | number: '1.0-0' }} KB)
                  <button class="m5" type="button" (click)="removeFile(i)"><i class="fa fa-times"></i></button>
                </li>
              </ul>
            </div>
            <div *ngIf="isPreview">
              <ul>
                <li *ngFor="let emailAttachmentDTO of emailActivity.emailAttachmentDTOs; let i = index">
                  <a *ngIf="emailAttachmentDTO.filePath != undefined" target="_blank" href="{{emailAttachmentDTO.filePath}}">{{emailAttachmentDTO.fileName}}</a>
                  <a *ngIf="emailAttachmentDTO.filePath == undefined" (click)="showFilePathError = 'true'">{{emailAttachmentDTO.fileName}}</a>
                  <span *ngIf="showFilePathError" class="text-danger" id="filePathError">Unable to load the file. <p (click)="showFilePathError = 'false'"><i class="fa fa-times"></i></p></span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="border: none">
        <button class="btn Btn-Gray neg_mrg_top4" (click)="closeEmailModal()" data-dismiss="modal">Cancel</button>
        <button *ngIf="!isPreview && !composeMail && !replyMail" type="submit" class="btn btn-primary" [disabled]="showFileTypeError || !isValidEmail || !isValidToEmailId"
          (click)="sendTestEmailToUser()">{{OliveAi ? 'Send Test Email' : 'Send Test Mail'}}</button>
        <button *ngIf="!isPreview" type="submit" class="btn btn-primary" [disabled]="showFileTypeError || !isValidEmail ||  !isValidToEmailId"
          (click)="sendEmailToUser()">{{OliveAi ? 'Send Email' : 'Send Mail'}}</button>
      </div>
    </div>
  </div>

  <div *ngIf="isTestMail" class="modal-dialog popup-width modal-copy" role="document">
    <ngx-loading [show]="testEmailLoading" [config]="{ backdropBorderRadius: '14px' }"></ngx-loading>
    <div class="modal-content mSweetalertWid popup-cu-widthalign">
      <div class="modal-header alert-info br">
        <h4 class="modal-title f-w-600" id="" translate="">{{OliveAi ? 'Send Test Email' : 'Send Test Mail'}}</h4>
      </div>
      <div class="modal-body">
        <div>
          <h4 class="modal-title-new">Please Enter Test Email Id</h4>
        </div>
        <div class="form-check pointer mt10">
          <label class="option-color">Email Id<span class="text-danger">*</span></label>
          <input *ngIf="!OliveAi"class="form-control" name="rdaction" (input)="validateTestEmailId()" [(ngModel)]="testToEmailId">
          <tag-input *ngIf="OliveAi" class="col-lg-11 col-md-11 col-sm-11 col-xs-11 p0" [(ngModel)]='toEmailIds' #tagInput name="emails" #email="ngModel"
               [errorMessages]="errorMessages" [validators]="validators"
               [separatorKeyCodes]="[32,188,186,13,9]" [placeholder]="'Add email'"
               [secondaryPlaceholder]="'Add EmailId(s)'" [clearOnBlur]="true" [addOnPaste]="true"
               [addOnBlur]="true" [pasteSplitPattern]="splitPattern" [onAdding]="onAddedFunc" theme='bootstrap'
               [onTextChangeDebounce]="40">
            </tag-input>
        </div>
      </div>
      <div class="modal-footer p-10">
        <button class="btn Btn-Gray" type="button" name="cancel" (click)="closeTestMailPopup()">Cancel</button>
        <button class="btn btn-primary" type="button" name="ok" [disabled]="!isValidTestEmailId && toEmailIds.length == 0"
          (click)="sendTestEmail()">{{OliveAi ? 'Send Test Email' : 'Send Test Mail'}}</button>
      </div>
    </div>
  </div>
</div>

<ng-template #emailTemplates let-emailTemplatesPagination="emailTemplatesPagination"
  let-selectedEmailTemplateRow="selectedEmailTemplateRow">
  <div class="col-lg-3 col-md-4 col-sm-6 col-xs-12 flex-row pointer template_padding"
    *ngFor="let emailTemplate of emailTemplatesPagination?.pagedItems ;let i =index">
    <div class="row">
      <div class="col-lg-12  col-md-12 col-sm-12 col-xs-12">
        <div class="grid-box imgage-paddings grid-email-card"
          [ngClass]="emailTemplate?.id === selectedEmailTemplateRow ? 'template-selected-border' :'' "
          (click)="selectEmailTemplate(emailTemplate)">
          <span class="select-check-box" [class.hide]="emailTemplate?.draft">
            <label>
              <input type="radio" class="radio-custimization pointer radioButton_shadow"
                [checked]="emailTemplate?.id === selectedEmailTemplateRow">
            </label>
          </span>
          <img class="img-grid-track" onerror="this.src='assets/images/no-preview.jpg';" [src]="emailTemplate?.subject"
            alt="No Preview Found" />
          <span class="icon-alignments">
            <a data-toggle="tooltip" data-placement="bottom" title="Preview"
              (click)="$event.stopPropagation();previewEmailTemplate(emailTemplate,false)"
              data-original-title="Preview">
              <i class="fa fa-external-link-square preview-edit-color tooltip-cls" aria-hidden="true"></i> </a>
          </span>
          <div class="bar hover-bar"
            [class.white-labeled-custom-css]="emailTemplate?.whiteLabeledEmailTemplateReceivedFromVendor">
            <a data-placement="top" class="border-none-dark">
              <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12 col-lg-12 emailtemp-content">
                  <div class="content-hover-align fontsize-cls">
                    <span class="item__name cardDetails-mar" data-toggle="tooltip" data-placement="bottom"
                      [title]="emailTemplate?.name">
                      <strong>{{emailTemplate?.name
                        |slice:0:20}}</strong>
                      <strong *ngIf="emailTemplate?.name?.length>20">..</strong>
                    </span>
                    <br>
                    <span class="item__name" data-toggle="tooltip" data-placement="bottom" title="Created On"
                      style="float:left; margin: 3px;">
                      <span>
                        <app-display-date-and-time
                          [dateAndTimeUTCString]="emailTemplate?.createdDate"></app-display-date-and-time>
                      </span>
                    </span>
                    <p class="cardDetails-mar" data-toggle="tooltip" data-placement="bottom"
                      title="{{emailTemplate?.createdBy}}">
                      <strong translate>Created
                        By:</strong>
                      <span>{{emailTemplate?.createdBy|slice:0:20}}
                        <span *ngIf="emailTemplate?.createdBy?.length>20">..</span>
                      </span>
                    </p>
                  </div>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="emailTemplatesPagination?.totalRecords==0 && !emailTemplatesOrLandingPagesLoader"
    class="alert alert-info text-center">
    <strong>No Data Found.</strong>
  </div>
</ng-template>
