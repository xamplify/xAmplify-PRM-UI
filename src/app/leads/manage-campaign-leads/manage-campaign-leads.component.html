<div class="page-bar m10" *ngIf="!httpRequestLoader.isLoading &&  !httpRequestLoader.isServerError"
  style="border:none !important;padding-bottom: 8px;">
  <app-response-message class="pg8 col-lg-12 col-md-12 col-sm-12 col-xs-12 p0" [customResponse]="leadsResponse"
    *ngIf="leadsResponse.isVisible"></app-response-message>
  <div class="col-xs-12 col-sm-5 col-lg-5" *ngIf="fromAnalytics && showTeamMemberFilter">
    <app-team-member-filter-option *ngIf="!authenticationService?.module?.isMarketingCompany"
      [customSelectedIndex]="selectedFilterIndex"
      (teamMemberFilterOptionEventEmitter)="getSelectedIndex($event)"></app-team-member-filter-option>
  </div>
  <div class="page-toolbar col-xs-10 col-sm-6 col-lg-6 mSearchAlign" style="padding-right: 2px;">
    <div class="btn-group pull-right" style="width: max-content;">
      <div class="inputs" align="right" style="float: right; display: inline-flex;">
        <div class="portlet-input input-inline" style="display: table-cell; margin-right: 15px;">
          <div class="input-icon right" style="position: relative;right: -11px;">
            <input type="text" class="form-control" [(ngModel)]="leadsSortOption.searchKey"
              [ngModelOptions]="{standalone: true}" placeholder="Search" (keypress)="leadEventHandler($event.keyCode)">
            <button class="glyphicon glyphicon-remove search-box-item-clear" *ngIf="leadsSortOption.searchKey"
              (click)="clearSearch()"></button>
            <button type="submit" class="search-box-item-click" (click)="searchLeads()">
              <i class="fa fa-search" aria-hidden="true"></i>
            </button>
          </div>
        </div>
        <span data-placement="bottom" class="btn btn-xs hidden-xs l-g-view mr5" data-toggle="tooltip" title="Filter"
          (click)="toggleFilterOption()">
          <i _ngcontent-c17="" aria-hidden="true" class="fa fa-filter p10"></i>
        </span>
        <button data-placement="bottom" class="btn btn-xs hidden-xs l-g-view" data-toggle="tooltip"
          title="Click here to email the report" [disabled]="leadsSortOption.totalRecords == 0"
          (click)="downloadLeads(leadsPagination)">
          <i _ngcontent-c17="" aria-hidden="true" class="fas fa-file-export p10"></i>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="row" id="box" *ngIf="httpRequestLoader.isServerError" translate>
  Please contact admin for 'Leads'
</div>
<app-list-loader *ngIf="httpRequestLoader.isLoading && !httpRequestLoader.isServerError">
</app-list-loader>
<!-- -------------------- Apply Filters Box-------------------- -->
<div class="row" *ngIf="showFilterOption && !httpRequestLoader.isLoading && !httpRequestLoader.isServerError">
  <div class="col-xs-12 col-sm-12">
    <div class="portlet light m10">
      <div class="portlet-title">
        <div class="caption" translate>Apply Filters</div>
        <button type="button" class="close-circle" style="margin-left:10px;" (click)="closeFilterOption()">
          <i class="fa fa-times" aria-hidden="true"></i>
        </button>
        <div class="form-group" style="text-align: -webkit-right;">
          <button class="button bgcolor-unset neg_mrgn_top4 mrgn_top0" translate="" type="button"
            ng-reflect-translate="" [disabled]="" (click)="validateDateFilters()"><span
              class="btn Btn-Green transition txt_pd-top3">Filter</span></button>
        </div>
      </div>
      <div class="portlet box">
        <app-response-message class="pg8" [customResponse]="filterResponse" *ngIf="filterResponse.isVisible">
        </app-response-message>
        <form role="form" class="form-horizontal form-bordered form-label-stripped">
          <div class="form-group">
            <div class="form-inline col-sm-12">
              <div class="form-group col-sm-4">
                <label class="control-label">From Date &nbsp;
                </label>
                <app-date-picker [(dataField)]="fromDateFilter" [isFromFilter]='true'>
                </app-date-picker>
              </div>
              <div class="form-group col-sm-4 form-group-mr">
                <label class="control-label">To Date &nbsp;
                </label>
                <app-date-picker [(dataField)]="toDateFilter" [isFromFilter]='true'>
                </app-date-picker>
              </div>
              <div class="row">
                <div class="form-group col-sm-6 ml0-mr0" style="margin-top: 13px;padding-left: 54px;;display: flex;">
                  <label class="control-label" style="padding-right: 5px;">Status &nbsp; </label>
                  <select class="form-control select-width" [(ngModel)]="statusFilter"
                    [ngModelOptions]="{standalone: true}">
                    <option value="">---Select Status---</option>
                    <option *ngFor="let stage of stageNamesForFilterDropDown" [value]="stage">{{stage}}
                    </option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<section class='m10'
  *ngIf="leadsSortOption.totalRecords > 0 && !httpRequestLoader.isLoading && !httpRequestLoader.isServerError">

  <div class="table-responsive">
    <table class='table tgrid table-hover table-sm' aria-describedby="leadTable">
      <thead>
        <tr>
          <th class="center-aligned" translate>Lead Details</th>
          <th class="center" translate>Added By</th>
          <th class="center" style="text-align:center" translate>Status</th>
          <th style="width: 18%; text-align:center" translate>Actions</th>
        </tr>

      </thead>

      <tbody>
        <ng-container *ngFor='let lead of leadsPagination.pagedItems; let i=index'>
          <tr>
            <td style="width: 36%;">
              <app-user-info [userInfo]="lead" [isLeadInfo]="true"></app-user-info>
              <div style="margin-left: 60px;">
                <h5 *ngIf="isPartnerVersion"><strong>Added For:</strong>
                  <span style="color: #5b9bd1;">{{lead.createdForCompanyName | slice:0:30}}
                    <span *ngIf="lead.createdForCompanyName?.length>20">...</span>
                  </span>
                </h5>
              </div>
              <div *ngIf="isPartnerVersion && lead?.campaignId > 0" style="margin-left: 60px;">
                <h5><strong>Campaign:</strong>
                  <span style="color: #5b9bd1;">{{lead.campaignName | slice:0:30}}
                    <span *ngIf="lead.campaignName?.length>30">...</span>
                  </span>
                </h5>
              </div>
              <div *ngIf="isVendorVersion && lead?.parentCampaignId > 0" style="margin-left: 60px;">
                <h5><strong>Campaign:</strong>
                  <span style="color: #5b9bd1;">{{lead.parentCampaignName | slice:0:30}}
                    <span *ngIf="lead.parentCampaignName?.length>30">...</span>
                  </span>
                </h5>
              </div>
              <div *ngIf="isVendorVersion && lead?.parentCampaignId <= 0 && lead?.campaignId > 0"
                style="margin-left: 60px;">
                <h5><strong>Campaign:</strong>
                  <span style="color: #5b9bd1;">{{lead.campaignName | slice:0:30}}
                    <span *ngIf="lead.campaignName?.length>30">...</span>
                  </span>
                </h5>
              </div>

            </td>
            <td class="mAlignment" style="width: 23%;">
              <h5 *ngIf="!isPartnerVersion">{{lead.createdByCompanyName | slice:0:30}}
                <span *ngIf="lead.createdByCompanyName?.length>20">...</span>
              </h5>
              <h5 class='ellipsis m_t_view' title="{{lead.createdByName}}"
                style="margin: 7px 0 2px 0;font-weight: 400;">{{lead.createdByName | slice:0:20}}
                <span *ngIf="lead.createdByName?.length>20">...</span>
              </h5>
              <h6 class='m0' style="font-weight: 400;">
                <a title="{{lead.createdByEmail}}">{{lead.createdByEmail | slice:0:30}}</a>
                <span *ngIf="lead.createdByEmail?.length>30">...</span>
              </h6>
              <h5 style="font-weight: 600; color: #676767;">
                <app-timestamp [isOnlyDate]="false" [dateAndTime]="lead.createdTime">
                </app-timestamp>
              </h5>
            </td>
            <td style="width: 23%; text-align: center;">
              {{lead.currentStageName | slice:0:30}}
              <div style="color: #06c306;" *ngIf="lead?.associatedDealId > 0" translate>
                <i class="fa fa-check-circle mr5" aria-hidden="true"
                  style="font-size:18px;margin-top: 13px; margin-left: 6px;"></i>
                Deal
              </div>
              <!-- XNFR-426 -->
              <div style="color: #f71111;"
                *ngIf="lead?.leadApprovalStatusType == 'REJECTED' && lead?.associatedDealId == undefined && !lead?.leadApprovalOrRejection"
                translate>
                <i class="fa fa-times-circle mr5" aria-hidden="true"
                  style="font-size:18px;margin-top: 13px; margin-left: 6px;"></i>
                Rejected
              </div>
              <div
                *ngIf="(lead?.canRegisterDeal && !lead?.leadApprovalOrRejection && !authenticationService?.module?.deletedPartner && lead?.leadApprovalStatusType !== 'REJECTED') || (lead?.selfLead && lead?.associatedDealId == undefined)">
                <button class="button_blue bgcolor-unset" (click)="registerDeal(lead)" translate>
                  <span class="btn btn-primary transition d-inline"> Register Deal</span>
                </button>
              </div>

              <div *ngIf="lead?.leadApprovalOrRejection  && !lead?.selfLead">
                <div *ngIf="!authenticationService?.module?.deletedPartner">
                  <div style="color: #06c306;"
                    *ngIf="lead?.leadApprovalStatusType == 'APPROVED' && lead?.associatedDealId == undefined">
                    <i class="fa fa-check-circle mr5" aria-hidden="true"
                      style="font-size:18px;margin-top: 13px; margin-left: 6px;"></i>
                    Approved
                  </div>
                  <div style="color: #f71111;"
                    *ngIf="lead?.leadApprovalStatusType == 'REJECTED' && lead?.associatedDealId == undefined">
                    <i class="fa fa-times-circle mr5" aria-hidden="true"
                      style="font-size:18px;margin-top: 13px; margin-left: 6px;"></i>
                    Rejected
                  </div>
                  <div *ngIf="lead?.canRegisterDeal">
                    <button class="button_blue bgcolor-unset" data-toggle="tooltip" data-placement="bottom"
                      title="{{lead?.leadApprovalStatusType ? (lead?.leadApprovalStatusType === 'REJECTED' ? 'You can not register a deal for a rejected lead' : '') : 'You can not register a deal for an unapproved lead'}}"
                      [disabled]="(  ((lead?.leadApprovalStatusType == 'REJECTED') || (lead?.leadApprovalStatusType == undefined && lead?.leadApprovalOrRejection)))"
                      (click)="registerDeal(lead)" translate>
                      <span class="btn btn-primary transition d-inline"> Register Deal</span>
                    </button>
                  </div>
                </div>
                <div class="buttons"
                  *ngIf="!(lead?.associatedDealId > 0) && !lead?.canRegisterDeal && !authenticationService?.module?.deletedPartner && lead?.leadApprovalStatusType == undefined && lead?.leadApprovalOrRejection">
                  <button type="button" class="button_blue bgcolor-unset" translate
                    (click)="addApprovalStatusModelPopup(lead,'APPROVED')"><span
                      class="btn btn-primary transition txt_pd-top3">Approve</span></button>
                  <button type="button" class="btn Btn-Gray neg_mrg_top4 pos_mrg_top3"
                    (click)="addApprovalStatusModelPopup(lead,'REJECTED')" translate>Reject</button>
                </div>
              </div>
            </td>
            <td>
              <div class="actions-block override-actions tb_view_actions">
                <a class="custom-icon" data-rel="fancybox-button" (click)="viewLead(lead)" data-toggle="tooltip" data-placement="bottom" title="View Lead"
                  data-toggle="tooltip" data-placement="bottom" id="lead">
                  <i class="fa fa-eye mr5 IconCustomization" aria-hidden="true"></i>
                  <div class="clickicons"></div>
                </a>
                <ng-container *ngIf="!authenticationService?.module?.deletedPartner">
                  <a class="custom-icon" data-rel="fancybox-button" data-toggle="tooltip" data-placement="bottom"
                    *ngIf="lead.canUpdate" (click)="lead?.leadApprovalStatusType !== 'REJECTED' ? editLead(lead) : ''"
                    title="{{lead?.leadApprovalStatusType == 'REJECTED' ? 'Editing rejected leads is not permitted' : 'Edit Lead'}}"
                    id="lead">
                    <i [ngClass]="lead?.leadApprovalStatusType == 'REJECTED' ? 'fa fa-edit mr5 IconCustomization disabled gray':'fa fa-edit mr5 IconCustomization'"
                      aria-hidden="true"></i>
                    <div class="clickicons"></div>
                  </a>
                  <a class="custom-icon" data-rel="fancybox-button" data-toggle="tooltip" data-placement="bottom"
                    *ngIf="lead.canUpdate" (click)="confirmDeleteLead(lead)" title="Delete Lead" id="lead">
                    <i class="fa fa-trash-o trashIconCustomization" aria-hidden="true"></i>
                    <div class="del-icon"></div>
                  </a>
                  <a class="custom-icon" *ngIf="true" data-rel="fancybox-button" (click)="showComments(lead)"
                    title="Comments/History" data-toggle="tooltip" data-placement="bottom">
                    <i class="fa fa-comments IconCustomization" aria-hidden="true" style="font-size:18px"> </i>
                    <span *ngIf="lead.unReadChatCount > 0" class="badge badge-default"
                      style="margin-bottom: 25px; margin-left: -15px;background-color: #ed1c24 !important;">{{lead.unReadChatCount}}</span>
                    <div class="clickicons"></div>
                  </a>
                </ng-container>

              </div>
            </td>
          </tr>

        </ng-container>
      </tbody>

    </table>
  </div>

  <!-- --------------------Pagination0-------------------- -->
  <div *ngIf="!httpRequestLoader.isLoading && leadsPagination.pagedItems.length !== 0" class="pg8">
    <app-pagination [pagination]="leadsPagination" (notifyParent)="setLeadsPage($event)"
      (notifyParentDropDown)="listCampaignLeads($event)"></app-pagination>
  </div>
  <!-- End of 24 -->
  <div *ngIf="!httpRequestLoader.isLoading && leadsPagination.totalRecords==0" class="alert alert-info">
    <strong translate>No Leads Found.</strong>
  </div>
</section>

<div *ngIf="!httpRequestLoader.isLoading && leadsSortOption.totalRecords==0" class="alert alert-info">
  <strong translate>No Leads Found.</strong>
</div>

<app-opportunities-chat-modal-popup *ngIf="updateCurrentStage" [leadApprovalStatusType]="leadApprovalStatusType"
  [lead]="selectedLead" [loggedInUserId]="loggedInUserId" (closePopupEmitter)="closeApprovalStatusModelPopup()">
</app-opportunities-chat-modal-popup>